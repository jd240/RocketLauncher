@model UserUpdateRequest

@{
    ViewBag.Title = "Update User";
}
<a href="~/users/index" class="link-hover"> Back to User List</a>
<h2>Update User</h2>
<div class="w-50">
    <form action="~/users/update/@Model.UserId" method="post">
        @*Hidden field for UserID*@
        <input type="hidden" name="UserID" value="@Model.UserId" />

        @*UserName*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="UserName" class="form-label">UserName</label>
            </div>
            <div class="flex-1">
                <input type="text" id="UserName" name="UserName" class="form-input" value="@Model.UserName" readonly />
            </div>
        </div>
        @*FirstName*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="FirstName" class="form-label">FirstName</label>
            </div>
            <div class="flex-1">
                <input type="text" id="FirstName" name="FirstName" class="form-input" value="@Model.FirstName" />
            </div>
        </div>
        @*LastName*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="LastName" class="form-label">LastName</label>
            </div>
            <div class="flex-1">
                <input type="text" id="LastName" name="LastName" class="form-input" value="@Model.LastName" />
            </div>
        </div>
        @*Email*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="Email" class="form-label pt">Email</label>
            </div>
            <div class="flex-1">
                <input type="email" id="Email" name="Email" class="form-input" value="@Model.Email" />
            </div>
        </div>

        @*DateOfBirth*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="DateOfBirth" class="form-label pt">Date of Birth</label>
            </div>
            <div class="flex-1">
                <input type="date" id="DateOfBirth" name="DateOfBirth" class="form-input" value="@Model.DateOfBirth?.ToString("yyyy-MM-dd")" />
            </div>
        </div>
        @*Role*@
        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label">Role</label>
            </div>
            <div class="flex-1">
                <input type="radio" id="User" name="UserRole" value="User" @(Model.UserRole == DataTransferObject.Enums.Role.User ? "checked" : "") />
                <label for="User">User</label>
                <input type="radio" id="Tenant" name="UserRole" value="Tenant" class="ml" @(Model.UserRole == DataTransferObject.Enums.Role.Tenant ? "checked" : "") />
                <label for="Tenant">Tenant</label>
            </div>
        </div>

        @*Tenant Name Input (Only for Tenant role)*@
        <div class="form-field flex" id="tenantNameInput" style="display: none;">
            <div class="w-25">
                <label for="TenantName" class="form-label">Tenant Name</label>
            </div>
            <div class="flex-1">
                <input type="text" id="TenantName" name="TenantName" class="form-input" value="@Model.TenantName" />
            </div>
        </div>

        @*Associate with Tenant Question (Only for User role)*@
        <div class="form-field flex" id="associateTenantQuestion" style="display: none;">
            <div class="w-25">
                <label class="form-label">Associate with Tenant?</label>
            </div>
            <div class="flex-1">
                <input type="radio" id="AssociateYes" name="AssociateTenant" value="Yes" @(Model.AssociatedTenantID != null ? "checked" : "") />
                <label for="AssociateYes">Yes</label>
                <input type="radio" id="AssociateNo" name="AssociateTenant" value="No" class="ml" @(Model.AssociatedTenantID == null ? "checked" : "") />
                <label for="AssociateNo">No</label>
            </div>
        </div>

        @*Tenant Dropdown*@
        <div class="form-field flex" id="tenantDropdown" style="display: none;">
            <div class="w-25">
                <label class="form-label" for="TenantID">Tenant Name</label>
            </div>
            <div class="flex-1">
                <select name="AssociatedTenantID" id="TenantID" class="form-input">
                    <option value="">Please Select</option>
                    @foreach (SelectListItem tenant in ViewBag.Tenants)
                    {
                        <option value="@tenant.Value" selected="@(tenant.Value == Model.AssociatedTenantID?.ToString())">@tenant.Text</option>
                    }
                </select>
            </div>
        </div>

        @*Address*@
        <div class="form-field flex">
            <div class="w-25">
                <label for="Address" class="form-label pt">Address</label>
            </div>
            <div class="flex-1">
                <textarea id="Address" name="Address" class="form-input">@Model.Address</textarea>
            </div>
        </div>

        @*Submit*@
        <div class="form-field flex">
            <div class="w-25">
            </div>
            <div class="flex-1">
                <button class="button button-green-back">Update</button>

                @if (ViewBag.Errors != null)
                {
                    <div class="text-red ml">
                        <ul>
                            @foreach (string error in ViewBag.Errors)
                            {
                                <li class="ml">@error</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </form>
</div>

<script>
    // Get elements
    const userRadio = document.getElementById('User');
    const tenantRadio = document.getElementById('Tenant');
    const tenantNameInput = document.getElementById('tenantNameInput');
    const associateTenantQuestion = document.getElementById('associateTenantQuestion');
    const tenantDropdown = document.getElementById('tenantDropdown');
    const associateYes = document.getElementById('AssociateYes');
    const associateNo = document.getElementById('AssociateNo');

    // Initialize visibility on page load
    function initializeFormState() {
        if (userRadio.checked) {
            tenantNameInput.style.display = 'none';
            associateTenantQuestion.style.display = 'flex';
            if (associateYes.checked) {
                tenantDropdown.style.display = 'flex';
            }
        } else if (tenantRadio.checked) {
            tenantNameInput.style.display = 'flex';
            associateTenantQuestion.style.display = 'none';
            tenantDropdown.style.display = 'none';
        }
    }

    // Handle role selection
    function handleRoleChange() {
        if (userRadio.checked) {
            tenantNameInput.style.display = 'none';
            document.getElementById('TenantName').value = ''; // Clear tenant name
            associateTenantQuestion.style.display = 'flex';
            // Don't reset values on edit page
        } else if (tenantRadio.checked) {
            tenantNameInput.style.display = 'flex';
            associateTenantQuestion.style.display = 'none';
            tenantDropdown.style.display = 'none';
            document.getElementById('TenantID').value = ''; // Clear tenant selection
        }
    }

    // Handle associate tenant question
    function handleAssociateChange() {
        if (associateYes.checked) {
            tenantDropdown.style.display = 'flex';
            removeError();
        } else if (associateNo.checked) {
            tenantDropdown.style.display = 'none';
            document.getElementById('TenantID').value = '';
            removeError();
        }
    }

    function showError(message) {
        removeError(); // Remove existing error first
        const tenantSelect = document.getElementById('TenantID');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'tenant-error';
        errorDiv.className = 'text-red';
        errorDiv.textContent = message;
        tenantSelect.parentElement.appendChild(errorDiv);
    }

    function removeError() {
        const existingError = document.getElementById('tenant-error');
        if (existingError) {
            existingError.remove();
        }
    }

    // Add event listeners
    document.querySelector('form').addEventListener('submit', function(event) {
        // Ensure TenantID is selected if associating with a tenant
        const tenantSelect = document.getElementById('TenantID');
        if (associateYes.checked && tenantSelect.value === '') {
            event.preventDefault();
            showError('Please select a tenant');
            tenantSelect.focus();
            return false;
        }
    });
    userRadio.addEventListener('change', handleRoleChange);
    tenantRadio.addEventListener('change', handleRoleChange);
    associateYes.addEventListener('change', handleAssociateChange);
    associateNo.addEventListener('change', handleAssociateChange);

    // Initialize on page load
    initializeFormState();

</script>